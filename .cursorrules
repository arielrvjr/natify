# Natify Framework - Cursor Rules

## DescripciÃ³n del Proyecto

**Natify Framework** es un framework de arquitectura hexagonal (Ports & Adapters) para React Native que abstrae las dependencias de librerÃ­as nativas y proporciona una API unificada y tipada.

### PropÃ³sito

- Desacoplar la lÃ³gica de negocio de las implementaciones nativas
- Facilitar el testing mediante inyecciÃ³n de dependencias
- Permitir cambiar librerÃ­as subyacentes sin afectar el cÃ³digo de la aplicaciÃ³n
- Proporcionar manejo de errores tipado y consistente
- Establecer governance sobre las capacidades nativas

---

## Arquitectura Hexagonal (Ports & Adapters)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        APLICACIÃ“N                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    @natify/core                    â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚   PORTS     â”‚  â”‚   ERRORS    â”‚  â”‚  PROVIDER   â”‚  â”‚    â”‚
â”‚  â”‚  â”‚ (Interfaces)â”‚  â”‚(NatifyErr)â”‚  â”‚  (Context)  â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                            â–²                                 â”‚
â”‚                            â”‚ implements                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚               @natify/*                    â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚http-axiosâ”‚ â”‚storage-  â”‚ â”‚biometricsâ”‚ â”‚store-  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚          â”‚ â”‚mmkv      â”‚ â”‚-rn       â”‚ â”‚zustand â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Flujo de Dependencias

1. **Core** define las interfaces (Ports)
2. **Adapters** implementan las interfaces usando librerÃ­as especÃ­ficas
3. **Apps** consumen los adapters a travÃ©s del NatifyProvider
4. Los componentes usan `useAdapter<Port>()` para obtener implementaciones

---

## Estructura del Monorepo

```
natify-framework/
â”œâ”€â”€ apps/
â”‚   â””â”€â”€ DemoApp/                 # App de demostraciÃ³n React Native
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ core/                    # @natify/core
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ ports/           # Interfaces (contratos)
â”‚   â”‚       â”œâ”€â”€ errors/          # Sistema de errores tipados
â”‚   â”‚       â”œâ”€â”€ context/         # NatifyProvider y hooks
â”‚   â”‚       â”œâ”€â”€ adapters/        # Adapters por defecto (logger)
â”‚   â”‚       â”œâ”€â”€ di/              # InyecciÃ³n de dependencias
â”‚   â”‚       â”œâ”€â”€ module/          # Sistema de mÃ³dulos
â”‚   â”‚       â”œâ”€â”€ viewmodel/       # BaseViewModel
â”‚   â”‚       â””â”€â”€ app/             # NatifyApp
â”‚   â””â”€â”€ adapters/                # @natify/*
â”‚       â”œâ”€â”€ http-axios/          # HttpClientPort â†’ Axios
â”‚       â”œâ”€â”€ storage-mmkv/        # StoragePort â†’ MMKV
â”‚       â”œâ”€â”€ storage-async/       # StoragePort â†’ AsyncStorage
â”‚       â”œâ”€â”€ storage-keychain/    # StoragePort â†’ Keychain
â”‚       â”œâ”€â”€ biometrics-rn/       # BiometricPort â†’ RN Biometrics
â”‚       â”œâ”€â”€ permissions-rn/      # PermissionPort â†’ RN Permissions
â”‚       â”œâ”€â”€ navigation-react/    # NavigationPort â†’ React Navigation
â”‚       â””â”€â”€ store-zustand/       # StateManagerPort â†’ Zustand
â”œâ”€â”€ package.json
â”œâ”€â”€ pnpm-workspace.yaml
â””â”€â”€ turbo.json
```

---

## Stack TecnolÃ³gico

| Herramienta | VersiÃ³n | PropÃ³sito |
|-------------|---------|-----------|
| **pnpm** | 10.24.0 | Package manager (workspaces) |
| **Turbo** | 2.6.2 | Build system monorepo |
| **TypeScript** | 5.9.3 | Tipado estÃ¡tico |
| **React Native** | 0.72+ | Framework mÃ³vil |
| **React** | 18.2+ | UI library |

---

## Puertos (Interfaces) Disponibles

### HttpClientPort
```typescript
interface HttpClientPort extends Port {
  readonly capability: "httpclient";
  setHeader(key: string, value: string): void;
  removeHeader(key: string): void;
  get<T>(url: string, config?: HttpRequestConfig): Promise<HttpResponse<T>>;
  post<T>(url: string, body?: unknown, config?: HttpRequestConfig): Promise<HttpResponse<T>>;
  put<T>(url: string, body?: unknown, config?: HttpRequestConfig): Promise<HttpResponse<T>>;
  patch<T>(url: string, body?: unknown, config?: HttpRequestConfig): Promise<HttpResponse<T>>;
  delete<T>(url: string, config?: HttpRequestConfig): Promise<HttpResponse<T>>;
}
```

### StoragePort
```typescript
interface StoragePort extends Port {
  readonly capability: "storage";
  getItem<T = string>(key: string): Promise<T | null>;
  setItem<T = string>(key: string, value: T): Promise<void>;
  removeItem(key: string): Promise<void>;
  clear(): Promise<void>;
}
```

### BiometricPort
```typescript
interface BiometricPort extends Port {
  readonly capability: "biometrics";
  isAvailable(): Promise<boolean>;
  getBiometryType(): Promise<BiometryType>;
  authenticate(promptTitle: string, cancelText?: string): Promise<{ success: boolean; error?: string }>;
}
```

### LoggerPort
```typescript
interface LoggerPort extends Port {
  readonly capability: "logger";
  log(level: LogLevel, message: string, metadata?: object): void;
  debug(message: string, metadata?: object): void;
  info(message: string, metadata?: object): void;
  warn(message: string, metadata?: object): void;
  error(message: string, error?: Error, metadata?: object): void;
}
```

### StateManagerPort
```typescript
interface StateManagerPort extends Port {
  readonly capability: "state-management";
  createStore<T>(setup: (set: SetState<T>, get: GetState<T>) => T): StoreApi<T>;
}
```

### AnalyticsPort
```typescript
interface AnalyticsPort {
  init(): Promise<void>;
  identify(userId: string, traits?: Record<string, unknown>): void;
  track(event: string, properties?: Record<string, unknown>): void;
  screen(name: string, properties?: Record<string, unknown>): void;
  reset(): void;
}
```

---

## CÃ³mo Crear un Nuevo Port

1. Crear archivo en `packages/core/src/ports/`:

```typescript
// packages/core/src/ports/MyNewPort.ts
import { Port } from "./Port";

export interface MyNewPort extends Port {
  readonly capability: "my-capability"; // Identificador Ãºnico
  
  // Definir mÃ©todos abstractos
  doSomething(): Promise<void>;
  getSomething(): string;
}
```

2. Exportar desde el index:

```typescript
// packages/core/src/ports/index.ts
export * from "./MyNewPort";
```

### Reglas para Ports

- âœ… Extender siempre de `Port`
- âœ… Definir `capability` como readonly con valor literal
- âœ… Usar tipos genÃ©ricos cuando sea posible
- âœ… MÃ©todos async para operaciones I/O
- âŒ NO incluir lÃ³gica de implementaciÃ³n
- âŒ NO importar librerÃ­as externas

---

## CÃ³mo Crear un Nuevo Adapter

1. Crear paquete en `packages/adapters/`:

```bash
mkdir -p packages/adapters/my-adapter/src
```

2. Crear `package.json`:

```json
{
  "name": "@natify/my-adapter",
  "version": "0.0.1",
  "main": "src/index.ts",
  "types": "src/index.ts",
  "peerDependencies": {
    "@natify/core": "*"
  },
  "dependencies": {
    "libreria-nativa": "^x.x.x"
  }
}
```

3. Implementar el adapter:

```typescript
// packages/adapters/my-adapter/src/index.ts
import { MyNewPort } from "@natify/core";
import { LibreriaNativa } from "libreria-nativa";

export class MyNewAdapter implements MyNewPort {
  readonly capability = "my-capability";
  
  private nativeLib = new LibreriaNativa();

  async doSomething(): Promise<void> {
    await this.nativeLib.action();
  }

  getSomething(): string {
    return this.nativeLib.getValue();
  }
}
```

### Reglas para Adapters

- âœ… Implementar TODA la interfaz del Port
- âœ… Definir `capability` con el mismo valor del Port
- âœ… Convertir errores nativos a `NatifyError`
- âœ… Encapsular completamente la librerÃ­a nativa
- âŒ NO exponer tipos de la librerÃ­a nativa
- âŒ NO lanzar errores no tipados

---

## Sistema de Errores

### NatifyError

```typescript
class NatifyError extends Error {
  public readonly code: NatifyErrorCode;
  public readonly originalError?: unknown;
  public readonly context?: Record<string, any>;
}
```

### CÃ³digos de Error Disponibles

| CÃ³digo | DescripciÃ³n |
|--------|-------------|
| `NETWORK_ERROR` | Error de red genÃ©rico |
| `TIMEOUT` | Timeout de peticiÃ³n |
| `UNAUTHORIZED` | HTTP 401 |
| `FORBIDDEN` | HTTP 403 |
| `NOT_FOUND` | HTTP 404 |
| `SERVER_ERROR` | HTTP 500+ |
| `STORAGE_READ_ERROR` | Error leyendo storage |
| `STORAGE_WRITE_ERROR` | Error escribiendo storage |
| `VALIDATION_ERROR` | Error de validaciÃ³n |
| `UNKNOWN` | Error desconocido |

### Uso en Adapters

```typescript
import { NatifyError, NatifyErrorCode } from "@natify/core";

// En el adapter
try {
  await nativeOperation();
} catch (error) {
  throw new NatifyError(
    NatifyErrorCode.NETWORK_ERROR,
    "FallÃ³ la operaciÃ³n",
    error,
    { url: "/api/users" }
  );
}
```

### Manejo en Componentes

```typescript
import { NatifyError, NatifyErrorCode } from "@natify/core";

try {
  await http.get("/users");
} catch (error) {
  if (error instanceof NatifyError) {
    switch (error.code) {
      case NatifyErrorCode.UNAUTHORIZED:
        // Redirigir a login
        break;
      case NatifyErrorCode.NETWORK_ERROR:
        // Mostrar "Sin conexiÃ³n"
        break;
    }
  }
}
```

---

## NatifyApp (ConfiguraciÃ³n Simplificada)

### Uso BÃ¡sico

```typescript
// App.tsx
import { NatifyApp } from "@natify/core";
import { AxiosHttpAdapter } from "@natify/http-axios";
import { MMKVStorageAdapter } from "@natify/storage-mmkv";
import { KeychainStorageAdapter } from "@natify/storage-keychain";
import { RnBiometricAdapter } from "@natify/biometrics-rn";
import { createReactNavigationAdapter } from "@natify/navigation-react";

import { AuthModule } from "./modules/auth";
import { ProductsModule } from "./modules/products";

export default function App() {
  return (
    <NatifyApp
      adapters={{
        http: new AxiosHttpAdapter("https://api.example.com"),
        storage: new MMKVStorageAdapter(),
        secureStorage: new KeychainStorageAdapter(),
        biometrics: new RnBiometricAdapter(),
        navigation: createReactNavigationAdapter(),
      }}
      modules={[AuthModule, ProductsModule]}
      initialModule="auth"
    />
  );
}
```

---

## Sistema de MÃ³dulos

### Crear un MÃ³dulo

```typescript
// modules/auth/index.ts
import { createModule } from "@natify/core";
import { LoginScreen } from "./screens/LoginScreen";
import { RegisterScreen } from "./screens/RegisterScreen";
import { LoginUseCase } from "./usecases/LoginUseCase";

export const AuthModule = createModule("auth", "Authentication")
  // Capacidades requeridas
  .requires("http", "secureStorage", "biometrics", "navigation")

  // Pantallas
  .screen({ name: "Login", component: LoginScreen })
  .screen({ name: "Register", component: RegisterScreen })

  // UseCases
  .useCase("login", (adapters) =>
    new LoginUseCase(adapters.http, adapters.secureStorage)
  )

  // Ruta inicial
  .initialRoute("Login")

  // InicializaciÃ³n (opcional)
  .onInit(async (adapters) => {
    console.log("Auth module loaded");
  })

  .build();
```

### Estructura de un MÃ³dulo

```
modules/
â””â”€â”€ auth/
    â”œâ”€â”€ index.ts              # DefiniciÃ³n del mÃ³dulo
    â”œâ”€â”€ screens/
    â”‚   â”œâ”€â”€ LoginScreen.tsx
    â”‚   â””â”€â”€ RegisterScreen.tsx
    â”œâ”€â”€ viewmodels/
    â”‚   â”œâ”€â”€ useLoginViewModel.ts
    â”‚   â””â”€â”€ useRegisterViewModel.ts
    â””â”€â”€ usecases/
        â”œâ”€â”€ LoginUseCase.ts
        â””â”€â”€ RegisterUseCase.ts
```

---

## UseCases

### Crear un UseCase

```typescript
// modules/auth/usecases/LoginUseCase.ts
import { HttpClientPort, StoragePort, NatifyError, NatifyErrorCode } from "@natify/core";

export interface LoginCredentials {
  email: string;
  password: string;
}

export class LoginUseCase {
  constructor(
    private readonly http: HttpClientPort,
    private readonly secureStorage: StoragePort,
  ) {}

  async execute(credentials: LoginCredentials): Promise<User> {
    // ValidaciÃ³n de negocio
    if (!credentials.email.includes("@")) {
      throw new NatifyError(NatifyErrorCode.VALIDATION_ERROR, "Email invÃ¡lido");
    }

    // Llamar API
    const response = await this.http.post<AuthResponse>("/auth/login", credentials);

    // Guardar token
    await this.secureStorage.setItem("auth_token", response.data.token);

    // Configurar header
    this.http.setHeader("Authorization", `Bearer ${response.data.token}`);

    return response.data.user;
  }
}
```

---

## ViewModels

### BaseViewModel

```typescript
import { useBaseViewModel, useUseCase, useAdapter, NavigationPort } from "@natify/core";
import { useState, useCallback } from "react";
import { LoginUseCase } from "../usecases/LoginUseCase";

export function useLoginViewModel() {
  // Estado base (loading, error)
  const [baseState, { execute, clearError }] = useBaseViewModel();

  // Estado del formulario
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");

  // UseCase inyectado (prefijo: moduleId:useCaseKey)
  const loginUseCase = useUseCase<LoginUseCase>("auth:login");

  // Navigation
  const navigation = useAdapter<NavigationPort>("navigation");

  const login = useCallback(async () => {
    const result = await execute(() =>
      loginUseCase.execute({ email, password })
    );

    if (result) {
      navigation.reset([{ name: "products/ProductList" }]);
    }
  }, [email, password, loginUseCase, navigation, execute]);

  return {
    state: {
      ...baseState,
      email,
      password,
    },
    actions: {
      setEmail,
      setPassword,
      login,
      clearError,
    },
  };
}
```

### Screen (Vista)

```typescript
// modules/auth/screens/LoginScreen.tsx
import { View, TextInput, Button, Text, ActivityIndicator } from "react-native";
import { useLoginViewModel } from "../viewmodels/useLoginViewModel";

export function LoginScreen() {
  const { state, actions } = useLoginViewModel();

  return (
    <View>
      <TextInput
        value={state.email}
        onChangeText={actions.setEmail}
        placeholder="Email"
        editable={!state.isLoading}
      />

      <TextInput
        value={state.password}
        onChangeText={actions.setPassword}
        secureTextEntry
        editable={!state.isLoading}
      />

      {state.error && <Text style={{ color: "red" }}>{state.error.message}</Text>}

      {state.isLoading ? (
        <ActivityIndicator />
      ) : (
        <Button title="Iniciar SesiÃ³n" onPress={actions.login} />
      )}
    </View>
  );
}
```

---

## InyecciÃ³n de Dependencias

### useUseCase

```typescript
// Obtener un UseCase registrado en un mÃ³dulo
const loginUseCase = useUseCase<LoginUseCase>("auth:login");
const getProductsUseCase = useUseCase<GetProductsUseCase>("products:getProducts");
```

### useAdapter

```typescript
// Obtener un adapter por nombre o capability
const http = useAdapter<HttpClientPort>("http");
const navigation = useAdapter<NavigationPort>("navigation");
```

---

## NavegaciÃ³n entre MÃ³dulos

```typescript
const navigation = useAdapter<NavigationPort>("navigation");

// Navegar a una pantalla de otro mÃ³dulo
navigation.navigate("products/ProductDetail", { productId: "123" });

// Reset del stack (Ãºtil despuÃ©s de login)
navigation.reset([{ name: "products/ProductList" }]);

// Regresar
navigation.goBack();
```

---

## Convenciones de CÃ³digo

### Naming

| Tipo | ConvenciÃ³n | Ejemplo |
|------|------------|---------|
| Port | `{Capability}Port` | `HttpClientPort`, `StoragePort` |
| Adapter | `{ImplementaciÃ³n}{Capability}Adapter` | `AxiosHttpAdapter`, `MMKVStorageAdapter` |
| Capability | `kebab-case` | `"httpclient"`, `"state-management"` |
| Paquete adapter | `@natify/{capability}-{implementation}` | `@natify/http-axios` |

### Estructura de Archivos

```
packages/adapters/my-adapter/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ index.ts        # Exporta el adapter
â”œâ”€â”€ package.json
â””â”€â”€ README.md           # DocumentaciÃ³n del adapter
```

### TypeScript

- Usar `readonly` para propiedades inmutables
- Preferir interfaces sobre types para Ports
- Usar generics para tipado flexible
- Exportar todos los tipos necesarios

---

## Comandos Ãštiles

```bash
# Instalar dependencias
pnpm install

# Desarrollo (todos los paquetes)
pnpm dev

# Ejecutar DemoApp en Android
pnpm android

# Ejecutar DemoApp en iOS
pnpm ios

# Build de todos los paquetes
pnpm turbo run build
```

---

## Roadmap de Capacidades

### Implementadas âœ…
- Storage (MMKV, AsyncStorage, Keychain)
- HTTP Client (Axios)
- Biometrics (RN Biometrics)
- State Management (Zustand)
- Logger (Console)
- Analytics (Composite adapter)
- Permissions (react-native-permissions)
- Navigation (React Navigation)

### Planificadas ğŸ“‹
- Camera/Media (react-native-image-picker)
- Location (react-native-geolocation-service)
- File System (react-native-blob-util)
- Theme Engine (@shopify/restyle)
- Toast/Alerts (react-native-toast-message)
- Crash Reporting (Sentry)
- Validation (Zod)

---

## Anti-Patrones a Evitar

âŒ **NO** importar librerÃ­as nativas directamente en componentes
âŒ **NO** lanzar errores sin convertirlos a `NatifyError`
âŒ **NO** exponer tipos de librerÃ­as nativas fuera del adapter
âŒ **NO** crear adapters sin implementar toda la interfaz del Port
âŒ **NO** usar `any` en las interfaces de Ports
âŒ **NO** acoplar lÃ³gica de negocio a implementaciones especÃ­ficas

âœ… **SÃ** usar `useAdapter<Port>()` para obtener implementaciones
âœ… **SÃ** tipar correctamente las respuestas y errores
âœ… **SÃ** documentar cada adapter con README
âœ… **SÃ** mantener los Ports agnÃ³sticos de implementaciÃ³n
âœ… **SÃ** usar el sistema de errores tipado

